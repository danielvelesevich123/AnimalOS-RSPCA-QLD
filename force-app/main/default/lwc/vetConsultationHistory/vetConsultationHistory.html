<template>
    <lightning-card title={headerTitle} icon-name="standard:task">
        <div slot="actions">
            <lightning-button-group>
                <lightning-button 
                    variant="neutral" 
                    label={expandAllLabel} 
                    icon-name={expandAllIcon}
                    onclick={handleExpandAll}>
                </lightning-button>
                <lightning-button 
                    variant="brand" 
                    label="Download PDF" 
                    icon-name="utility:download"
                    onclick={handleDownloadPDF}>
                </lightning-button>
            </lightning-button-group>
        </div>
        
        <div class="slds-card__body slds-card__body_inner">
            <template if:true={loading}>
                <lightning-spinner alternative-text="Loading vet consultation records..."></lightning-spinner>
            </template>
            
            <template if:true={error}>
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                    <span class="slds-assistive-text">Error</span>
                    <span class="slds-icon_container slds-icon-utility-error slds-m-right_x-small" title="Error">
                        <lightning-icon icon-name="utility:error" alternative-text="Error" size="x-small"></lightning-icon>
                    </span>
                    <h2>Error loading vet consultations: {error}</h2>
                </div>
            </template>
            
            <template if:true={noRecords}>
                <div class="slds-text-align_center slds-p-around_large">
                    <lightning-icon icon-name="utility:info" size="medium" class="slds-m-bottom_small"></lightning-icon>
                    <p class="slds-text-body_regular slds-text-color_weak">No vet consultation records found for this animal.</p>
                </div>
            </template>
            
            <template if:false={loading}>
                <div class="accordion-container">
                    <template for:each={vetConsults} for:item="consult" for:index="index">
                        <div key={consult.id} class="accordion-section" data-current={consult.isCurrentConsult}>
                            <!-- Current Consultation Banner -->
                            <template if:true={consult.isCurrentConsult}>
                                <div class="current-consult-banner">
                                    <lightning-icon icon-name="utility:success" size="x-small"></lightning-icon>
                                    <span>CURRENT CONSULTATION</span>
                                </div>
                            </template>
                            
                            <!-- Accordion Header -->
                            <div class="accordion-header" onclick={handleAccordionToggle}>
                                <div class="accordion-header-content">
                                    <div class="accordion-title-group">
                                        <h3 class="accordion-title">
                                            Vet Consultation - {consult.scheduledStart}
                                        </h3>
                                        <div class="accordion-subtitle">
                                            {consult.vet} â€¢ {consult.type}
                                        </div>
                                    </div>
                                    <div class="accordion-header-right">
                                        <div class="consult-id-badge">
                                            <lightning-icon icon-name="utility:file" size="xx-small"></lightning-icon>
                                            <span>ID: {consult.consultId}</span>
                                        </div>
                                        <div class="accordion-toggle-icon">
                                            <template if:true={consult.isExpanded}>
                                                <lightning-icon icon-name="utility:chevronup" size="small"></lightning-icon>
                                            </template>
                                            <template if:false={consult.isExpanded}>
                                                <lightning-icon icon-name="utility:chevrondown" size="small"></lightning-icon>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Accordion Content -->
                            <template if:true={consult.isExpanded}>
                                <div class="accordion-content">
                                    <div class="consult-details">
                                        <div class="detail-row">
                                            <div class="detail-item">
                                                <div class="detail-label">CONSULTATION DATE:</div>
                                                <div class="detail-value">{consult.scheduledStart}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">VET:</div>
                                                <div class="detail-value">{consult.vet}</div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-item">
                                                <div class="detail-label">CONSULT TYPE:</div>
                                                <div class="detail-value">{consult.type}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">REASON FOR CONSULTATION:</div>
                                                <div class="detail-value">{consult.description}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Notes Section -->
                                    <template if:true={consult.notes}>
                                        <div class="notes-section">
                                            <div class="notes-header">NOTES ({consult.relatedRecords.animalNotes.length}):</div>
                                            <div class="notes-content">
                                                <lightning-formatted-rich-text value={consult.notes}></lightning-formatted-rich-text>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Related Records Sections -->
                                    <template if:true={consult.relatedRecords}>
                                        <!-- Conditions -->
                                        <template if:true={consult.relatedRecords.conditions}>
                                            <template if:false={consult.relatedRecords.conditions.length}>
                                                <!-- Empty template to prevent rendering when no conditions -->
                                            </template>
                                            <template if:true={consult.relatedRecords.conditions.length}>
                                                <div class="related-section">
                                                    <div class="related-header">CONDITIONS ({consult.relatedRecords.conditions.length}):</div>
                                                    <template for:each={consult.relatedRecords.conditions} for:item="condition">
                                                        <div key={condition.id} class="related-item">
                                                            <div class="related-item-name">{condition.name}</div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </template>
                                        
                                        <!-- Action Plans -->
                                        <template if:true={consult.relatedRecords.actionPlans}>
                                            <template if:false={consult.relatedRecords.actionPlans.length}>
                                                <!-- Empty template to prevent rendering when no action plans -->
                                            </template>
                                            <template if:true={consult.relatedRecords.actionPlans.length}>
                                                <div class="related-section">
                                                    <div class="related-header">ACTION PLANS ({consult.relatedRecords.actionPlans.length}):</div>
                                                    <template for:each={consult.relatedRecords.actionPlans} for:item="plan">
                                                        <div key={plan.id} class="related-item">
                                                            <div class="related-item-name">{plan.name}</div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </template>
                                        
                                        <!-- Medicines Used -->
                                        <template if:true={consult.relatedRecords.medicinesUsed}>
                                            <template if:false={consult.relatedRecords.medicinesUsed.length}>
                                                <!-- Empty template to prevent rendering when no medicines -->
                                            </template>
                                            <template if:true={consult.relatedRecords.medicinesUsed.length}>
                                                <div class="related-section">
                                                    <div class="related-header">MEDICINES USED ({consult.relatedRecords.medicinesUsed.length}):</div>
                                                    <template for:each={consult.relatedRecords.medicinesUsed} for:item="medicine">
                                                        <div key={medicine.id} class="related-item">
                                                            <div class="related-item-name">{medicine.name}</div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </template>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </lightning-card>
</template>