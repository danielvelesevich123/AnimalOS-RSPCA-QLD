<template>
    <div class="slds-card slds-card_boundary slds-m-top_medium">
        <lightning-card title="Movement Tracker Custom" icon-name="standard:location">
            <div class="slds-m-around_medium slds-is-relative">
                <!-- Current Animal Info -->
                <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                    <div class="slds-text-heading_small slds-m-bottom_x-small">
                        Analysing movements for: <strong>{currentAnimalName}</strong>
                    </div>
                    <div class="slds-text-body_small slds-text-color_weak">
                        Select a date range to find other animals that shared the same block locations during overlapping periods.
                    </div>
                </div>

                <!-- Date Range Inputs -->
                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <div class="slds-col slds-size_1-of-4">
                        <lightning-input
                                type="date"
                                data-map="filter"
                                data-path="startDate"
                                name="startDate"
                                label="Start Date"
                                value={filter.startDate}
                                disabled={isLoading}
                                placeholder="Select Start Date..."
                                onchange={handleFieldChange}
                                required>
                        </lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <lightning-input
                                type="date"
                                name="endDate"
                                data-map="filter"
                                data-path="endDate"
                                label="End Date"
                                value={filter.endDate}
                                disabled={isLoading}
                                onchange={handleFieldChange}
                                placeholder="Select End Date..."
                                required>
                        </lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <c-vertic-select
                                label="Animal Stage"
                                value={filter.animalStage}
                                data-map="filter"
                                data-path="animalStage"
                                disabled={isLoading}
                                none-label="-- None --"
                                options={selectOptions.animalosStageOptions}
                                onchange={handleAnimalStageChange}
                                placeholder="Select Animal Stage...">
                        </c-vertic-select>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <lightning-combobox
                                label="Animal Status"
                                value={filter.animalStatus}
                                data-map="filter"
                                data-path="animalStatus"
                                options={animalStatusOptions}
                                onchange={handleFieldChange}
                                placeholder="Select Animal Status..."
                                disabled={isAnimalStatusDisabled}>
                        </lightning-combobox>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <div class="slds-col">
                        <lightning-button
                                variant="brand"
                                label="Analyse Movements"
                                onclick={handleSearch}
                                disabled={isSearchDisabled}
                                class="slds-m-right_small">
                        </lightning-button>
                        <lightning-button
                                variant="neutral"
                                label="Clear"
                                disabled={isLoading}
                                class="slds-m-right_small"
                                onclick={handleClear}>
                        </lightning-button>
                        <lightning-button
                                variant="brand"
                                lwc:if={hasResults}
                                label="Download CSV"
                                disabled={isLoading}
                                onclick={handleDownloadCSVClick}>
                        </lightning-button>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <template lwc:if={isLoading}>
                    <div class="slds-is-relative slds-m-vertical_large">
                        <lightning-spinner alternative-text="Analysing movement data..." size="medium"></lightning-spinner>
                    </div>
                </template>

                <!-- Error Display -->
                <template lwc:if={error}>
                    <c-scoped-notification-lwc theme="error" icon-name="utility:error" icon-variant="error">
                        <strong>Error:</strong> {error}
                    </c-scoped-notification-lwc>
                </template>

                <!-- Results Section -->
                <template lwc:if={hasResults}>
                    <div class="slds-m-top_medium">
                        <div class="slds-section slds-is-open">
                            <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small slds-p-vertical_medium" title="Movement Analysis Results">
                                Movement Analysis Results
                                    <lightning-badge label={movementData.length} class="slds-m-left_small"></lightning-badge>
                            </span>
                            </h3>
                            <div class="slds-section__content">
                                <div class="slds-m-bottom_small">
                                    <div class="slds-text-body_small slds-text-color_weak">
                                        Movement overlaps for <strong>{currentAnimalName}</strong> during the specified date range:
                                    </div>
                                </div>
                                <lightning-datatable
                                        key-field="id"
                                        data={movementData}
                                        columns={columns}
                                        hide-checkbox-column="true"
                                        show-row-number-column="true"
                                        sorted-by={sortedBy}
                                        sorted-direction={sortedDirection}
                                        onsort={handleSort}>
                                </lightning-datatable>
                            </div>
                        </div>
                    </div>
                </template>
                <template lwc:else>
                    <div class="slds-align_absolute-center slds-m-vertical_large">
                        <div class="slds-text-heading_small slds-text-color_weak">
                            <lightning-icon icon-name="utility:info" size="small" class="slds-m-right_small"></lightning-icon>
                            No overlapping movements found for the selected date range.
                        </div>
                    </div>
                </template>
            </div>
        </lightning-card>
    </div>
</template>